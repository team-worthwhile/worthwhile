% vim: spell spelllang=de:
\section{Interpreter}

Der Interpreter führt in der WHILE-""Sprache formulierte Programme aus und stellt eine Schnittstelle zum Debuggen von Programmen zur Laufzeit bereit. Des Weiteren überprüft er mit Hilfe des Evaluators zur Laufzeit die mittels Annotationen in den Programmtext eingebetteten Annotationen. Der Interpreter läuft in einem eigenen Thread und interagiert mit Hilfe von gemeinsam genutzten Datenstrukturen mit dem GUI-Thread.

\subsection{Eingabedaten}

\subsubsection{Programmspezifikation}

% copy-pasta von Beweiserschnittstelle oder ein neuer Abschnitt, der diesen Begriff einmal definiert?

\subsubsection{Klassenentwurf}

\subsubsection{class ExecutionContext}
Instanzen von \texttt{ExecutionContext} verwalten den Zustand eines Ausführungskontextes. Dazu gehören ein \texttt{ExpressionEvaluator}, ein \texttt{StatementExecutor} sowie eine \texttt{SymbolTable}, in der in diesem Kontext angelegte Symbole gespeichert werden.

%\begin{description}
%    \method{private SymbolTable symbolTable}
%    \method{private StatementExecutor statementExecutor}
%    \method{private ExpressionEvaluator expressionEvaluator}
%\end{description}

\begin{description}
<<<<<<< HEAD
    \method{public String getCurrentFunctionName()} % TODO should this really be a String?
    Gibt den Namen der in diesem Kontext ausgeführten Funktion zurück.
=======
    \method{public String getName()}
    Gibt einen Namen zurück, der diesem Kontext zugeordnet wurde. Normalerweise ist dies der Name der gerade ausgeführten Funktion.
>>>>>>> [ew] Add ReadableInterpreter, improve ExecutionContextStack

    \method{public SymbolTable getSymbolTable()}
    Gibt die aktuell gültige Symboltabelle zur Inspektion und Veränderung zrück.

    \method{protected void executeStatement(Statement statement)}
    Führt in diesem Kontext das angegebene Statement aus.

    \method{protected Object evaluateExpression(Expression expression)}
    Wertet in diesem Kontext die gegebene Expression aus und gibt das Ergebnis der Auswertung zurück.
\end{description}


\subsubsection{class ExecutionContextStack extends java.util.Stack<ExecutionContext>}

Instanzen von \texttt{ExecutionContextStack} verwalten eine Menge von "`gestapelten"' \texttt{ExecutionContext}-Objekten. Die Klasse \texttt{Interpreter} verwendet diesen Stack, um die für Funktionsaufrufe benötigten mehreren Instanzen von \texttt{ExecutionContext} einfach zu verwalten.

\subsubsection{class Interpreter}

Instanzen von \texttt{Interpreter} kontrollieren die Ausführung eines initial übergebenen Programms.

\begin{description}
    \method{public Interpreter(IParseResult parseResult)}
    Erzeugt eine Instanz, die das Programm, definiert durch die Parserausgabe \texttt{parseResult}, ausführen kann. Das Interface IParseResult wird vom Xtext Framework zur Verfügung gestellt und enthält neben dem AST Metainformationen wie beispielsweise die Positionen der Syntaxelemente im gelesenen Quelltext.

    \method{public void execute()}
    Startet die Ausführung des im Konstruktor übergebenen Programms in dieser Interpreter-""Instanz.

    \method{public void addDebugEventPolicy(AbstractDebugEventPolicy debugPolicy)}
    Fügt dem Interpreter eine Instanz einer Unterklasse von \texttt{AbstractDebugEventPolicy} hinzu und fügt sie der Menge der bei Ereignissen zu benachrichtigenden Objekte hinzu.

    \method{public void removeDebugEventPolicy(AbstractDebugEventPolicy debugPolicy)}
    Entfernt eine Instanz einer Unterklasse von \texttt{AbstractDebugEventPolicy} aus der Menge der bei Ereignissen zu benachrichtigenden Objekte.

    \method{public boolean addBreakpoint(int line)}
    Fügt einen Breakpoint in der gegebenen Zeile ein.

    \method{public boolean addBreakpoint(int line, \textbf{TODO} condition)} % Welche sprache?
    Fügt einen Breakpoint in der gegebenen Zeile ein, dessen Erreichen nur dann ein Ereignis auslöst, wenn die Aussage \texttt{condition} wahr ist.

    \method{public boolean clearBreakpoint(int line)}
    Entfernt den Breakpoint in der gegebenen Zeile.

    \method{public ExecutionContextStack getExecutionContextStack()} % TODO: in diesen Strukturen nur manche sachen public machen!
    Entfernt den Breakpoint in der gegebenen Zeile.

    %\method{public void executeStatement(Statement s)}
    %Führt das gegebene Statement aus und aktualisiert bei Bedarf die Symboltabelle.
\end{description}

\subsubsection{class ReadableInterpreter extends Interpreter}

\begin{description}
    \method{public ReadableInterpreter(Readable inputReadable)}
    Konstruiert eine neue \texttt{Interpreter}-""Instanz durch Lesen der Spezifikation des Programms in der WHILE-""Sprache aus dem übergebenen Readable-""Objekt.
\end{description}


\subsubsection{interface ExpressionEvaluator}
Die Aufgabe von \texttt{ExpressionEvaluator} Instanzen ist es, \texttt{Expression} Objekte aus dem AST auszuwerten.
\begin{description}
    \method{public Object eval(Expression expression)}
    Wertet die Expression \texttt{expression} aus und gibt das Ergebnis zurück.
\end{description}

\subsubsection{class InterpreterExpressionEvaluator implements ExpressionEvaluator}
Wertet Expressions aus, für die zur Auswertung Zugriff auf den \texttt{ExecutionContext} sowie den \texttt{Interpreter} nötig ist, beispielsweise um Funktionsaufrufe auszuwerten oder die Werte referenzierter Variablen aufzulösen.

\subsubsection{abstract class AbstractDebugEventPolicy}
Instanzen von Unterklassen von \texttt{AbstractDebugEventPolicy} behandeln Ereignisse, die bei der Ausführung des Programms auftreten. Die Methoden dieser Klasse werden dabei vom Interpreter synchron aufgerufen, was es dem Policy-Objekt erlaubt, die Ausführung anzuhalten oder zu verzögern. Dabei müssen nicht alle Methoden überschrieben werden -- eine Unterklasse von AbstractDebugEventPolicy kann auch nur auf eine Teilmenge der definierten Ereignisse reagieren.

\begin{description}
    \method{protected void statementExecuted()}
    Wird vom Interpreter nach jedem Ausführen eines Statements aufgerufen.
    \method{protected void expressionEvaluated()}
    Wird vom Interpreter nach jedem Auswerten einer Expression aufgerufen.
    \method{protected void executionStarted()}
    Wird vom Interpreter direkt nach dessen Start aufgerufen.
    \method{protected void executionTerminatedNormally()}
    Wird vom Interpreter nach ordnungsgemäßer Terminierung des Programms aufgerufen.
    \method{protected void executionTerminatedAbnormally()}
    Wird vom Interpreter nach einer fehlerbedingten Terminierung des Programms, ausgelöst beispielsweise durch einen Laufzeitfehler, aufgerufen.
    \method{protected void breakpointReached()}
    Wird vom Interpreter aufgerufen, nachdem ein Breakpoint erreicht (und gegebenenfalls die damit assoziierte Bedingung als wahr ausgewertet) wurde.
    \method{protected void assertionSucceeded()}
    Wird vom Interpreter nach jeder erfolgreichen Ausführung einer Zusicherungsinstruktion aufgerufen.
    \method{protected void assertionFailed()}
    Wird vom Interpreter nach jeder fehlgeschlagenen Ausführung einer Zusicherungsinstruktion aufgerufen.
\end{description}
